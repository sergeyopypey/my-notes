<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>AUI Test</title>
</head>

<body class="aui-page-focused aui-page-focused-small">
    <link rel="stylesheet" href="/node_modules/@atlassian/aui/dist/aui/aui-prototyping.css">
    <link rel="stylesheet" href="/node_modules/@atlassian/aui/dist/aui/aui-prototyping.nodeps.css">
    <style src="/node_modules/@atlassian/aui/dist/aui/aui-prototyping.css"></style>
    <style src="/node_modules/@atlassian/aui/dist/aui/aui-prototyping.nodeps.css"></style>
    <script src="/node_modules/jquery/dist/jquery.js"></script>
    <script src="/node_modules/jquery/dist/jquery.min.js"></script>
    <script src="/node_modules/@atlassian/aui/dist/aui/aui-prototyping.js"></script>
    <script src="/node_modules/@atlassian/aui/dist/aui/aui-prototyping.nodeps.js"></script>
    <section role="dialog" id="sr-dialog" class="aui-dialog2 aui-dialog2-medium">
        <header class="aui-dialog2-header">
            <h2 class="aui-dialog2-header-main">Notes</h2>
            <a class="aui-dialog2-header-close">
                <span class="aui-icon aui-icon-small aui-iconfont-close-dialog">Close</span>
            </a>
        </header>
        <div class="aui-dialog2-content">
            <!-- Utility header: search + count -->
            <div style="display:flex;gap:8px;align-items:center;margin-bottom:12px;">
                <div class="notes-search-wrapper" style="display:flex;align-items:center;gap:8px;flex:1;max-width:720px;">
                    <span class="aui-icon aui-icon-small aui-iconfont-search" aria-hidden="true" style="color:#6b778c;margin-left:6px"></span>
                    <input id="notes-search" class="aui-field-text" type="search" placeholder="Search notes... (Ctrl+K)" aria-label="Search notes" style="border:none;background:transparent;outline:none;flex:1;padding:6px 4px;font-size:14px">
                    <button id="notes-clear" class="aui-button aui-button-subtle aui-button-compact" title="Clear search" aria-label="Clear search" style="display:none;margin-right:6px"><span class="aui-icon aui-icon-small aui-iconfont-close" aria-hidden="true"></span></button>
                </div>
                <div id="notes-count" style="font-size:0.9em;color:#555;margin-left:auto">0 notes</div>
            </div>

            <!-- Add / New note form (collapsed by default) -->
            <div id="new-note-form" style="display:none;margin-bottom:12px">
                <form class="aui-note-form" onsubmit="return false;">
                    <div>
                        <label class="aui-label" for="new-note-title">Title <span style="font-weight:400;color:#6b778c">(optional)</span></label>
                        <input id="new-note-title" class="aui-field-text" type="text" placeholder="Short title" aria-label="Note title">
                    </div>
                    <div>
                        <label class="aui-label" for="new-note-due">Due date <span style="font-weight:400;color:#6b778c">(optional)</span></label>
                        <input id="new-note-due" class="aui-field-text" type="datetime-local" aria-label="Due date">
                    </div>

                    <div class="field-full">
                        <label class="aui-label" for="new-note-text">Note</label>
                        <textarea id="new-note-text" class="aui-field-text note-textarea" rows="4" placeholder="Write a new note..." aria-label="Note text"></textarea>
                        <div class="hint">Tip: leave the title empty to use the first line of the note as a title.</div>
                    </div>

                    <div class="note-form-actions">
                        <button id="save-new-note" class="aui-button aui-button-primary aui-button-compact"><span class="aui-icon aui-icon-small aui-iconfont-disk" aria-hidden="true"></span>Save</button>
                        <button id="cancel-new-note" class="aui-button aui-button-compact"><span class="aui-icon aui-icon-small aui-iconfont-close" aria-hidden="true"></span> Cancel</button>
                    </div>
                </form>
            </div>

            <!-- Notes container (rendered by JS) -->
            <div id="notes-list" aria-live="polite"></div>

            <!-- Hidden: preserve original static content as seeds for first load -->
            <div id="_seed_notes" style="display:none">
                <div class="seed">My note #1: What happens when you add a shiny new browser to a stack of already-disagreeing citizens? You’ll inevitably find some bugs. This is the story of how we found a rendering quirk and how the Atlassian frontend team found and refined the fix. The problem The Atlassian User Interface (AUI) library has just finished an IE10 sprint to get our library prepped and ready for the newest member of the browser family. While IE10 seems generally quite good, we found a couple of problems due to IE10 dropping conditional comments; plus some undesirable behaviours.</div>
                <div class="seed">My note #2: What happens when you add a shiny new browser to a stack of already-disagreeing citizens? You’ll inevitably find some bugs. This is the story of how we found a rendering quirk and how the Atlassian frontend team found and refined the fix. The problem The Atlassian User Interface (AUI) library has just finished an IE10 sprint to get our library prepped and ready for the newest member of the browser family. While IE10 seems generally quite good, we found a couple of problems due to IE10 dropping conditional comments; plus some undesirable behaviours.</div>
            </div>
        <footer class="aui-dialog2-footer">
            <div class="aui-dialog2-footer-actions left-action">
                <button id="dialog-delete-all-button" class="aui-button aui-button-primary">New note</button>
            </div>
            <div class="aui-dialog2-footer-actions">
                <button id="dialog-close-button" class="aui-button aui-button-link">Close</button>
            </div>
        </footer>
    </section>
    <style>
        /* Ensure footer uses flex so we can push actions to sides */
        .aui-dialog2-footer {
            display: flex;
            align-items: center;
        }

        /* Utility to push this action to the left */
        .left-action {
            margin-right: auto;
        }
        /* Make dialog layout vertical so header/content/footer behave well when content scrolls */
        #sr-dialog {
            display: flex;
            flex-direction: column;
            max-height: 80vh;
            box-sizing: border-box;
        }

        /* Scrollable content area (keeps footer visible) */
        .aui-dialog2-content {
            overflow: auto;
            flex: 1 1 auto;
            padding-right: 12px; /* allow room for scrollbar */
            box-sizing: border-box;
        }

        /* Sticky footer: remains visible while content scrolls */
        .aui-dialog2-footer {
            position: sticky;
            bottom: 0;
            z-index: 10;
            background: linear-gradient(180deg, rgba(255,255,255,0.92), rgba(255,255,255,0.985));
            border-top: 1px solid rgba(9,30,66,0.06);
            padding: 10px 16px;
        }
        /* Note actions (edit/delete) — aligned icon buttons */
        .note-actions {
            display: flex;
            flex-direction: column;
            gap: 6px;
            margin-left: 8px;
            align-items: center;
            justify-content: flex-start;
        }
        /* ensure actions don't grow and content can shrink properly */
        .note-actions { flex: 0 0 auto; }
        .note-content { flex: 1; min-width: 0; }
        /* improve wrapping for long/continuous strings to avoid overflow */
        .note-text { margin-top:6px; white-space:pre-wrap; overflow-wrap:break-word; word-break:break-word; }
        .note-actions .aui-button {
            width: 34px;
            height: 34px;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        /* ensure both action buttons have identical left margin */
        .note-actions .note-action-btn { margin-left: 8px; }
        .note-actions .aui-icon {
            font-size: 14px;
            line-height: 1;
        }
        /* Search styling */
        .notes-search-wrapper { background: #f4f6f8; border: 1px solid rgba(9,30,66,0.06); padding: 6px 8px; border-radius: 6px; }
        #notes-search { font-size: 14px; color: #172b4d; }
        #notes-clear { padding: 4px; min-width: 32px; }
        /* Due date badge */
        .note-due {
            font-size: 0.82em;
            margin-top: 6px;
            color: #444;
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            background: #f4f4f4;
        }
        .note-due.due-overdue { background: #fff0f0; color: #a00; }
        .note-due.due-soon { background: #fff8e6; color: #b45b00; }
        /* Overdue attention state */
        @keyframes burn {
            0% { box-shadow: 0 0 0 0 rgba(224,68,68,0.08); }
            50% { box-shadow: 0 0 18px 8px rgba(224,68,68,0.16); }
            100% { box-shadow: 0 0 0 0 rgba(224,68,68,0.08); }
        }
        .note-overdue {
            border: 1px solid rgba(224,68,68,0.9);
            animation: burn 1.6s ease-in-out infinite;
            background: linear-gradient(90deg, rgba(255,240,240,0.6), rgba(255,255,255,0));
        }
        .note-overdue .note-due { font-weight:700; color: #a00; }
        /* Note form (create / edit) layout — use AUI look */
        .aui-note-form {
            display: grid;
            grid-template-columns: 1fr 220px;
            gap: 8px;
            align-items: start;
            width: 100%;
            padding: 12px;
            border-radius: 6px;
            border: 1px solid rgba(9,30,66,0.08);
            background: linear-gradient(180deg, #fff 0%, #fbfcfd 100%);
            box-shadow: 0 1px 0 rgba(9,30,66,0.02);
            box-sizing: border-box;
            min-width: 0;
        }
        .aui-note-form label, .aui-note-form .aui-label { font-size:0.9em; color:#344563; margin-bottom:4px; display:block }
        .aui-note-form .field-full { grid-column: 1 / -1; }
        .aui-note-form .note-textarea { width:100%; max-width:100%; min-height:88px; resize:vertical; padding:8px; border-radius:4px; border:1px solid rgba(9,30,66,0.08); box-sizing:border-box; }
        .aui-note-form .aui-field-text { padding:6px 8px; border-radius:4px; border:1px solid rgba(9,30,66,0.08); box-sizing:border-box; max-width:100%; }
        .aui-note-form * { box-sizing: border-box; }
        .aui-note-form .note-form-actions { grid-column: 1 / -1; display:flex; justify-content:flex-end; gap:8px; margin-top:6px; }
        .aui-note-form .hint { font-size:0.8em;color:#6b778c }
        /* responsive: stack fields on narrow screens */
        @media (max-width:520px) {
            .aui-note-form { grid-template-columns: 1fr; }
        }
    </style>
    <script>
        AJS.toInit(function () {
            console.log("AUI initialized", AJS.version);

            /* Notes manager: add/edit/delete, search, localStorage persistence */
            const STORAGE_KEY = 'my-notes-data-v1';

            function nowTimestamp() {
                return new Date().toISOString();
            }

            function loadSeedNotes() {
                const seeds = Array.from(document.querySelectorAll('#_seed_notes .seed')).map(s => ({
                    id: 'seed-' + Math.random().toString(36).slice(2,9),
                    title: '',
                    text: s.textContent.trim(),
                    created: nowTimestamp(),
                }));
                return seeds;
            }

            function loadNotes() {
                try {
                    const raw = localStorage.getItem(STORAGE_KEY);
                    if (raw) return JSON.parse(raw);
                } catch (e) { console.warn('Failed to parse notes', e); }
                // fallback to seeds
                return loadSeedNotes();
            }

            function saveNotes(notes) {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(notes));
            }

            // DOM helpers
            const listEl = document.getElementById('notes-list');
            const countEl = document.getElementById('notes-count');
            let notes = loadNotes();

            function renderNotes(filter = '') {
                listEl.innerHTML = '';
                const f = filter.trim().toLowerCase();
                let filtered = notes.filter(n => (n.title + ' ' + n.text).toLowerCase().includes(f));

                function getStatus(n) {
                    // 0 = overdue, 1 = soon (<24h), 2 = normal
                    if (!n.due) return 2;
                    const diff = new Date(n.due) - new Date();
                    if (diff < 0) return 0;
                    if (diff <= 24 * 60 * 60 * 1000) return 1;
                    return 2;
                }

                // sort: overdue first, then soon, then others. Within each group sort by due date (earliest first) or created date
                filtered.sort((a, b) => {
                    const sa = getStatus(a); const sb = getStatus(b);
                    if (sa !== sb) return sa - sb;
                    const ta = a.due ? new Date(a.due).getTime() : new Date(a.created).getTime();
                    const tb = b.due ? new Date(b.due).getTime() : new Date(b.created).getTime();
                    return ta - tb;
                });
                countEl.textContent = `${filtered.length} note${filtered.length===1? '' : 's'}`;

                if (filtered.length === 0) {
                    listEl.innerHTML = '<div style="color:#666">No notes found.</div>';
                    return;
                }

                filtered.forEach(n => {
                    const card = document.createElement('div');
                    card.className = 'aui-message aui-message-info';
                    // Add overdue attention state
                    if (n.due && new Date(n.due) - new Date() < 0) {
                        card.className += ' note-overdue';
                        // make screen readers aware when rendering
                        card.setAttribute('aria-label', 'Overdue note. ' + (n.title || n.text.slice(0,40)));
                    }
                    card.style.marginBottom = '8px';
                    // compute due text and class
                    let dueHtml = '';
                    if (n.due) {
                        const dueDate = new Date(n.due);
                        const now = new Date();
                        const diff = dueDate - now;
                        const oneDay = 24 * 60 * 60 * 1000;
                        const cls = diff < 0 ? 'due-overdue' : (diff <= oneDay ? 'due-soon' : '');
                        dueHtml = `<div class="note-due ${cls}" title="Due: ${dueDate.toLocaleString()}">Due: ${dueDate.toLocaleString()}</div>`;
                    }

                    card.innerHTML = `
                        <div style="display:flex;align-items:flex-start;gap:8px;">
                                <div class="note-content">
                                <strong class="note-title">${escapeHtml(n.title || (n.text.split('\n')[0].slice(0,60) + (n.title? '':'...')))}</strong>
                                <div style="display:flex;gap:10px;align-items:center;margin-top:4px">${dueHtml}</div>
                                <div class="note-text">${escapeHtml(n.text)}</div>
                            </div>
                            <div class="note-actions">
                                <button class="aui-button aui-button-subtle aui-button-compact note-edit note-action-btn" data-id="${n.id}" title="Edit" aria-label="Edit note ${escapeHtml(n.title || n.text.slice(0,40))}"><span class="aui-icon aui-icon-small aui-iconfont-edit" aria-hidden="true"></span></button>
                                <button class="aui-button aui-button-subtle aui-button-compact note-delete note-action-btn" data-id="${n.id}" data-action="delete" title="Delete" aria-label="Delete note ${escapeHtml(n.title || n.text.slice(0,40))}"><span class="aui-icon aui-icon-small aui-iconfont-remove" aria-hidden="true"></span></button>
                            </div>
                        </div>
                    `;

                    // Expand/collapse: clicking title toggles long text
                    const textEl = card.querySelector('.note-text');
                    if (n.text.length > 300) {
                        textEl.style.maxHeight = '4.5em';
                        textEl.style.overflow = 'hidden';
                        textEl.style.position = 'relative';
                        const more = document.createElement('button');
                        more.className = 'aui-button aui-button-link aui-link-muted';
                        more.textContent = 'Read more';
                        more.addEventListener('click', () => {
                            if (more.textContent === 'Read more') {
                                textEl.style.maxHeight = '';
                                more.textContent = 'Read less';
                            } else {
                                textEl.style.maxHeight = '4.5em';
                                more.textContent = 'Read more';
                            }
                        });
                        card.appendChild(more);
                    }

                    listEl.appendChild(card);
                });
            }

            function escapeHtml(s) {
                return String(s)
                    .replace(/&/g, '&amp;')
                    .replace(/</g, '&lt;')
                    .replace(/>/g, '&gt;')
                    .replace(/"/g, '&quot;')
                    .replace(/'/g, '&#039;');
            }

            // UI: search
            const searchEl = document.getElementById('notes-search');
            const searchClearBtn = document.getElementById('notes-clear');

            function updateClearVisibility() {
                if (searchEl.value && searchEl.value.trim().length > 0) {
                    searchClearBtn.style.display = 'inline-flex';
                } else {
                    searchClearBtn.style.display = 'none';
                }
            }

            searchEl.addEventListener('input', () => { renderNotes(searchEl.value); updateClearVisibility(); });
            searchClearBtn.addEventListener('click', () => { searchEl.value = ''; renderNotes(''); updateClearVisibility(); searchEl.focus(); });

            // Keyboard shortcut: focus search on Ctrl+K or /
            document.addEventListener('keydown', (e) => {
                if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 'k') { e.preventDefault(); searchEl.focus(); }
                if (!e.ctrlKey && !e.metaKey && e.key === '/') { // focus with slash
                    const active = document.activeElement;
                    if (active && (active.tagName === 'INPUT' || active.tagName === 'TEXTAREA')) return;
                    e.preventDefault(); searchEl.focus();
                }
            });

            // initial state
            updateClearVisibility();

            // New note form toggling
            const newForm = document.getElementById('new-note-form');
            const newNoteBtn = document.getElementById('dialog-delete-all-button'); // repurpose button labeled "New note"
            const newTitle = document.getElementById('new-note-title');
            const newText = document.getElementById('new-note-text');
            document.getElementById('save-new-note').addEventListener('click', () => {
                const t = (newTitle.value || '').trim();
                const txt = (newText.value || '').trim();
                const dueVal = document.getElementById('new-note-due').value;
                if (!txt) { newText.focus(); return; }
                const item = { id: 'n-' + Math.random().toString(36).slice(2,9), title: t, text: txt, created: nowTimestamp(), due: dueVal ? new Date(dueVal).toISOString() : null };
                notes.unshift(item);
                saveNotes(notes);
                newTitle.value = '';
                newText.value = '';
                document.getElementById('new-note-due').value = '';
                newForm.style.display = 'none';
                renderNotes(searchEl.value);
            });
            document.getElementById('cancel-new-note').addEventListener('click', () => {
                newTitle.value = ''; newText.value = ''; newForm.style.display = 'none';
            });
            newNoteBtn.addEventListener('click', () => {
                newForm.style.display = (newForm.style.display === 'none') ? 'block' : 'none';
                if (newForm.style.display === 'block') newText.focus();
            });

            // Snackbar container for undo
            const snackbarContainer = document.createElement('div');
            snackbarContainer.id = 'snackbar-container';
            snackbarContainer.style.position = 'fixed';
            snackbarContainer.style.bottom = '20px';
            snackbarContainer.style.left = '20px';
            snackbarContainer.style.zIndex = '1100';
            document.body.appendChild(snackbarContainer);

            const pendingDeletes = {};

            function showSnackbar(message, undoCallback, key) {
                // Clear existing for same key
                snackbarContainer.innerHTML = '';
                const bar = document.createElement('div');
                bar.className = 'aui-message';
                bar.style.display = 'flex';
                bar.style.gap = '8px';
                bar.style.alignItems = 'center';
                bar.style.padding = '8px 12px';
                bar.innerHTML = `<div style="flex:1">${escapeHtml(message)}</div>`;
                const undoBtn = document.createElement('button');
                undoBtn.className = 'aui-button aui-button-compact';
                undoBtn.textContent = 'Undo';
                undoBtn.addEventListener('click', () => { if (typeof undoCallback === 'function') undoCallback(); snackbarContainer.innerHTML = ''; });
                bar.appendChild(undoBtn);
                snackbarContainer.appendChild(bar);
            }

            // Delegate edit/delete
            listEl.addEventListener('click', (ev) => {
                const del = ev.target.closest('.note-delete');
                if (del) {
                    const id = del.getAttribute('data-id');
                    if (!id) return;
                    const item = notes.find(n => n.id === id);
                    if (!item) return;

                    // Remove immediately from UI and storage, but allow undo for short time
                    notes = notes.filter(n => n.id !== id);
                    saveNotes(notes);
                    renderNotes(searchEl.value);

                    // store pending delete
                    if (pendingDeletes[id] && pendingDeletes[id].timeout) clearTimeout(pendingDeletes[id].timeout);
                    pendingDeletes[id] = { item };
                    const key = id;
                    showSnackbar('Note deleted', () => {
                        // undo
                        if (pendingDeletes[key]) {
                            notes.unshift(pendingDeletes[key].item);
                            saveNotes(notes);
                            renderNotes(searchEl.value);
                            clearTimeout(pendingDeletes[key].timeout);
                            delete pendingDeletes[key];
                        }
                    }, key);

                    // finalize after 5s
                    pendingDeletes[id].timeout = setTimeout(() => {
                        delete pendingDeletes[id];
                        // keep storage as-is (already removed)
                        snackbarContainer.innerHTML = '';
                    }, 5000);
                    return;
                }

                const editBtn = ev.target.closest('.note-edit');
                if (editBtn) {
                    const id = editBtn.getAttribute('data-id');
                    const item = notes.find(n => n.id === id);
                    if (!item) return;
                    openInlineEditor(id, item);
                }
            });

            function toDateTimeLocal(iso) {
                if (!iso) return '';
                const d = new Date(iso);
                const pad = (n) => String(n).padStart(2, '0');
                const yyyy = d.getFullYear();
                const mm = pad(d.getMonth() + 1);
                const dd = pad(d.getDate());
                const hh = pad(d.getHours());
                const min = pad(d.getMinutes());
                return `${yyyy}-${mm}-${dd}T${hh}:${min}`;
            }

            function openInlineEditor(id, item) {
                const card = Array.from(listEl.children).find(c => c.querySelector('.note-edit')?.getAttribute('data-id') === id);
                if (!card) return;
                const container = document.createElement('form');
                container.className = 'aui-note-form';
                container.setAttribute('onsubmit', 'return false;');
                container.innerHTML = `
                    <div>
                        <label class="aui-label">Title <span style="font-weight:400;color:#6b778c">(optional)</span></label>
                        <input class="aui-field-text edit-title" type="text" value="${escapeHtml(item.title)}">
                    </div>
                    <div>
                        <label class="aui-label">Due date <span style="font-weight:400;color:#6b778c">(optional)</span></label>
                        <input type="datetime-local" class="aui-field-text edit-due" value="${toDateTimeLocal(item.due)}">
                    </div>
                    <div class="field-full">
                        <label class="aui-label">Note</label>
                        <textarea class="aui-field-text edit-text note-textarea" rows="4">${escapeHtml(item.text)}</textarea>
                        <div class="hint">Tip: empty due date means no deadline.</div>
                    </div>
                    <div class="note-form-actions">
                        <button class="aui-button aui-button-primary aui-button-compact edit-save"><span class="aui-icon aui-icon-small aui-iconfont-disk" aria-hidden="true"></span>Save</button>
                        <button class="aui-button aui-button-compact edit-cancel"><span class="aui-icon aui-icon-small aui-iconfont-close" aria-hidden="true"></span> Cancel</button>
                    </div>
                `;
                // replace card content
                const original = card.innerHTML;
                card.innerHTML = '';
                card.appendChild(container);

                card.querySelector('.edit-cancel').addEventListener('click', () => { card.innerHTML = original; });
                card.querySelector('.edit-save').addEventListener('click', () => {
                    const t = card.querySelector('.edit-title').value.trim();
                    const txt = card.querySelector('.edit-text').value.trim();
                    const dueVal = card.querySelector('.edit-due').value;
                    if (!txt) { card.querySelector('.edit-text').focus(); return; }
                    notes = notes.map(n => n.id === id ? { ...n, title: t, text: txt, due: dueVal ? new Date(dueVal).toISOString() : null } : n);
                    saveNotes(notes);
                    renderNotes(searchEl.value);
                });
            }

            // Initial render
            renderNotes();
        });
    </script>
</body>

</html>