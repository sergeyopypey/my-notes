<section role="dialog" id="sr-dialog" class="aui-dialog2 aui-dialog2-medium">
    <header class="aui-dialog2-header">
        <h2 class="aui-dialog2-header-main">Notes</h2>
        <a class="aui-dialog2-header-close">
            <span class="aui-icon aui-icon-small aui-iconfont-close-dialog">Close</span>
        </a>
    </header>
    <div id="my-notes-header">
        <ul class="aui-nav my-notes-nav">
            <li id="my-notes-quicksearch-menu">
                <span class="aui-icon aui-icon-small aui-iconfont-search"></span>
                <input id="my-notes-search" class="aui-search-input" type="search" placeholder="Search notes"
                    aria-label="Search notes">
            </li>
            <li id="my-notes-count-menu">
                <p class="aui-text-subtle" id="my-notes-count">0 notes</p>
            </li>
        </ul>
    </div>
    <div id="my-notes-editor">
        <form id="my-notes-editor-form" class="aui my-notes-form">
            <div class="my-notes-fields-container">
                <div class="field-group my-notes-field-group">
                    <label for="my-notes-title">Title<span class="aui-icon icon-required">(required)</span></label>
                    <input class="text" type="text" id="my-notes-title" name="title" maxlength="127" required>
                </div>
                <div class="field-group my-notes-field-group">
                    <label for="my-notes-duedate">Due date</label>
                    <input class="text datepicker-input" type="datetime-local" id="my-notes-duedate" name="duedate">
                </div>
                <div class="field-group my-notes-field-group">
                    <label for="my-notes-text">Note<span class="aui-icon icon-required">(required)</span></label>
                    <textarea class="textarea" id="my-notes-text" name="text" maxlength="255" rows="4"
                        required></textarea>
                </div>
            </div>
            <div class="aui-dialog2-footer">
                <div class="aui-dialog2-footer-actions my-notes-footer-actions">
                    <button id="my-notes-editor-cancel-button" class="aui-button" type="button">Cancel</button>
                </div>
                <div class="my-notes-footer-actions">
                    <button id="my-notes-editor-save-button" class="aui-button aui-button-primary"
                        type="submit">Save</button>
                </div>
            </div>
        </form>
    </div>
    <div id="my-notes-list">
        <table class="aui">
            <tbody>
                <!-- Notes will be dynamically inserted here -->
                <!-- <tr id="my-notes-item-${note.id}">
                    <td>
                        <div class="aui-message my-notes-item">
                            <div class="my-notes-content">
                                <strong class="title">${note.title}</strong>
                                <div class="my-notes-duedate">
                                    Due: ${new Date(note.dueDate).toLocaleString()}
                                </div>
                                <div class="my-notes-text">
                                    <p>${note.text}</p>
                                </div>
                            </div>
                            <div class="my-notes-actions">
                                <button class="aui-button aui-button-subtle aui-button-compact my-notes-action-button"
                                    title="Edit note">
                                    <span class="aui-icon aui-icon-small aui-iconfont-edit">Edit</span>
                                </button>
                                <button class="aui-button aui-button-subtle aui-button-compact my-notes-action-button"
                                    title="Delete note">
                                    <span class="aui-icon aui-icon-small aui-iconfont-remove">Delete</span>
                                </button>
                            </div>
                        </div>
                    </td>
                </tr> -->
            </tbody>
        </table>
    </div>
    <footer class="aui-dialog2-footer">
        <div class="aui-dialog2-footer-actions my-notes-footer-actions">
            <button id="my-notes-close-dialog-button" class="aui-button aui-button-link">Close</button>
        </div>
        <div class="my-notes-footer-actions">
            <button id="my-notes-new-note-button" class="aui-button aui-button-primary">New note</button>
        </div>
    </footer>
    <script>
        const MYNOTES_PROPERTY_KEY = "com.troshin.jira.plugins.mynotes"
        const MYNOTES_DOESNT_EXIST_ERROR = "The property " + MYNOTES_PROPERTY_KEY + " does not exist."

        AJS.toInit(function () {
            // Initially hide note editor
            AJS.$("#my-notes-editor").hide()

            // Show note editor on button click
            AJS.$("#my-notes-new-note-button").click(function () {
                AJS.$("#my-notes-editor").show();
            });

            // Close dialog
            AJS.$("#my-notes-close-dialog-button, .aui-iconfont-close-dialog").click(function () {
                AJS.dialog2("#sr-dialog").remove();
            });

            // Search notes
            AJS.$("#my-notes-search").on("input", function () {
                const query = this.value.toLowerCase();
                AJS.$("#my-notes-list tbody tr").each(function () {
                    const title = AJS.$(this).find(".title").text().toLowerCase();
                    const text = AJS.$(this).find(".my-notes-text").text().toLowerCase();
                    if (title.includes(query) || text.includes(query)) {
                        AJS.$(this).show();
                    } else {
                        AJS.$(this).hide();
                    }
                });
            });

            // Fetch and render notes on dialog open
            renderNotesList();

            // Handle note editor form submission
            AJS.$("#my-notes-editor-form").submit(function (event) {
                event.preventDefault();
                let notes = getAllNotes();
                console.log("Fetched notes data:", notes);
                const newNote = {
                    id: Date.now().toString(),
                    title: this.title.value,
                    tags: [], // Tags can be added later
                    dueDate: this.duedate.value,
                    text: this.text.value
                };
                notes.push(newNote);
                createOrUpdateNotesProperty(notes);
                this.reset();
                AJS.$("#my-notes-editor").hide();
                renderNotesList();
            });

            // Hide note editor on cancel
            AJS.$("#my-notes-editor-cancel-button").click(function () {
                AJS.$("#my-notes-editor-form")[0].reset();
                AJS.$("#my-notes-editor").hide();
            });
        });

        function getAllNotes() {
            let notes = null;
            const userName = JIRA.Users.LoggedInUser.userName();
            const response = AJS.$.ajax({
                url: AJS.contextPath() + "/rest/api/2/user/properties/" + MYNOTES_PROPERTY_KEY + "?username=" + userName,
                type: "GET",
                contentType: "application/json",
                async: false,
                success: function (response) {
                    return response;
                },
                error: function (xhr, status, error) {
                    const errorMessages = xhr.responseJSON ? xhr.responseJSON.errorMessages : ["Unknown error"];
                    if (errorMessages[0] == MYNOTES_DOESNT_EXIST_ERROR) {
                        console.log("Notes property does not exist yet. Returning empty notes list.");
                        return [];
                    }
                    console.error("Error fetching notes property:", errorMessages.join(", "));
                    var myFlag = AJS.flag({
                        type: 'error',
                        body: 'Error fetching notes: ' + errorMessages.join(", ")
                    });
                }
            });
            notes = response.responseJSON.value || [];
            return notes;
        }

        function createOrUpdateNotesProperty(notes) {
            const userName = JIRA.Users.LoggedInUser.userName();
            AJS.$.ajax({
                url: AJS.contextPath() + "/rest/api/2/user/properties/" + MYNOTES_PROPERTY_KEY + "?username=" + userName,
                type: "PUT",
                contentType: "application/json",
                data: JSON.stringify(notes),
                async: false,
                success: function () {
                    console.log("Notes property created/updated successfully");
                },
                error: function (xhr, status, error) {
                    console.error("Error creating/updating notes property:", error);
                }
            });
        }

        function editNoteById(noteId) {
            alert("Edit functionality is not implemented yet for note ID: " + noteId);
        }

        function deleteNoteById(noteId) {
            const userName = JIRA.Users.LoggedInUser.userName();
            let notes = getAllNotes();
            notes = notes.filter(note => note.id !== noteId);
            AJS.$.ajax({
                url: AJS.contextPath() + "/rest/api/2/user/properties/" + MYNOTES_PROPERTY_KEY + "?username=" + userName,
                type: "PUT",
                contentType: "application/json",
                data: JSON.stringify(notes),
                async: false,
                success: function () {
                    console.log("Note deleted successfully");
                },
                error: function (xhr, status, error) {
                    console.error("Error deleting note:", error);
                }
            });
            renderNotesList();
        }

        function renderNotesList() {
            let notes = getAllNotes();
            let notesCounts = notes ? notes.length : 0;
            AJS.$("#my-notes-count").text(notesCounts + (notesCounts === 1 ? " note" : " notes"));
            console.log("Initial notes data:", notes);
            const notesListContainer = AJS.$("#my-notes-list tbody");
            notesListContainer.empty(); // Clear existing notes

            notes.forEach(note => {
                const dueDate = new Date(note.dueDate);
                const isOverdue = note.dueDate && dueDate < new Date();
                const noteRow = AJS.$(`
                    <tr id="my-notes-item-${note.id}">
                        <td>
                            <div class="aui-message my-notes-item">
                                <div class="my-notes-content">
                                    <strong class="title">${note.title}</strong>
                                    <div class="my-notes-duedate ${isOverdue ? 'my-notes-overdue' : ''}">
                                        Due: ${note.dueDate ? new Date(note.dueDate).toLocaleString() : "No dueDate"}
                                    </div>
                                    <div class="my-notes-text">
                                        <p>${note.text}</p>
                                    </div>
                                </div>
                                <div class="my-notes-actions">
                                    <button class="aui-button aui-button-subtle aui-button-compact my-notes-action-button" title="Edit note">
                                        <span class="aui-icon aui-icon-small aui-iconfont-edit">Edit</span>
                                    </button>
                                    <button class="aui-button aui-button-subtle aui-button-compact my-notes-action-button" title="Delete note">
                                        <span class="aui-icon aui-icon-small aui-iconfont-remove">Delete</span>
                                    </button>
                                </div>
                            </div>
                        </td>
                    </tr>
                `);
                notesListContainer.append(noteRow);
            });

            AJS.$(".aui-iconfont-edit").parent().click(function () {
                const noteId = AJS.$(this).closest("tr").attr("id").replace("my-notes-item-", "");
                editNoteById(noteId);
            });

            AJS.$(".aui-iconfont-remove").parent().click(function () {
                const noteId = AJS.$(this).closest("tr").attr("id").replace("my-notes-item-", "");
                confirm("Are you sure you want to delete this note?") && deleteNoteById(noteId);
            });
        }
    </script>
    <style>
        #sr-dialog {
            max-height: 80vh;
        }

        /* #my-notes-editor {
            display: block;
        } */

        #my-notes-quicksearch-menu {
            display: flex;
            align-items: center;
            gap: 6px;
            background: #f4f6f8;
            border: 1px solid rgba(9, 30, 66, 0.06);
            padding: 6px 8px;
            border-radius: 6px;
        }

        #my-notes-search {
            border: none;
            background: transparent;
            width: 100%;
            outline: none;
        }

        #my-notes-list {
            overflow-y: auto;
        }

        .my-notes-nav {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 16px;
        }

        /* .my-notes-fields-container {
            display: grid;
            grid-template-columns: 1fr 220px;
            align-items: start;
        }

        .my-notes-field-group {

        } */

        .my-notes-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .my-notes-duedate {
            margin-top: 6px;
            background: #f4f4f4;
            color: #444;
            padding: 4px 8px;
            border-radius: 4px;
        }

        .my-notes-overdue {
            background: #ffebe6;
            color: #bf2600;

        }

        .my-notes-content {
            margin-top: 6px;
            word-break: break-word;
        }

        .my-notes-actions {
            display: flex;
            flex-direction: column;
        }

        .my-notes-action-button {
            margin-left: auto;
            margin-top: 8px;
        }
    </style>
</section>